# Taxi Backend API

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ —Ç–∞–∫—Å–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîê **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏
- üöó **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∞–º–∏** (—Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–∏–Ω—è—Ç–∏–µ, –æ—Ç–º–µ–Ω–∞, —Å—Ç–∞—Ç—É—Å—ã)
- üìç **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è** –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
- üí¨ **–ß–∞—Ç** –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –≤–æ–¥–∏—Ç–µ–ª–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- üí≥ **–°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π** (–∫–∞—Ä—Ç—ã, –Ω–∞–ª–∏—á–Ω—ã–µ)
- üìä **–ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫** –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- üëë **–ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å** —Å –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- üîÑ **WebSocket** –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- üõ°Ô∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** —Å rate limiting –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- üìù **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Node.js** + **TypeScript**
- **Express.js** –¥–ª—è REST API
- **Socket.io** –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **SQLite** —Å **Knex.js** –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **JWT** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **bcryptjs** –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
- **Winston** –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∫–ª–∏–µ–Ω—Ç—ã, –≤–æ–¥–∏—Ç–µ–ª–∏, –∞–¥–º–∏–Ω—ã)
- `user_profiles` - –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `drivers` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª—è—Ö
- `rides` - –ø–æ–µ–∑–¥–∫–∏
- `chat_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
- `payment_cards` - –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –∫–∞—Ä—Ç—ã

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd backend
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```bash
# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
npm run db:migrate

# –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
npm run db:seed
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` –≤ `.env` –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```bash
cp .env.example .env
```

### 4. –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
npm run dev
```

### 5. –°–±–æ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```bash
npm run build
npm start
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3001`

## API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`/api/auth`)
- `POST /register` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /login` - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `GET /me` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### –ü–æ–µ–∑–¥–∫–∏ (`/api/rides`)
- `POST /` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç—ã)
- `POST /:rideId/accept` - –ü—Ä–∏–Ω—è—Ç–∏–µ –ø–æ–µ–∑–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–æ–¥–∏—Ç–µ–ª–∏)
- `PATCH /:rideId/status` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–µ–∑–¥–∫–∏
- `PATCH /:rideId/cancel` - –û—Ç–º–µ–Ω–∞ –ø–æ–µ–∑–¥–∫–∏
- `GET /active` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /history` - –ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫

### –°–ª—É–∂–µ–±–Ω—ã–µ
- `GET /api/health` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API

## WebSocket –°–æ–±—ã—Ç–∏—è

### –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤:
- `new_ride_request` - –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–µ–∑–¥–∫—É
- `driver_assigned` - –í–æ–¥–∏—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω
- `driver_location_updated` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
- `ride_status_updated` - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–µ–∑–¥–∫–∏
- `ride_cancelled` - –ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
- `new_message` - –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ

### –î–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π:
- `new_ride_request` - –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–µ–∑–¥–∫—É
- `ride_taken` - –ü–æ–µ–∑–¥–∫–∞ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –≤–æ–¥–∏—Ç–µ–ª–µ–º
- `ride_status_updated` - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–µ–∑–¥–∫–∏
- `ride_cancelled` - –ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
- `new_message` - –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ

### –°–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
- `update_location` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
- `driver_status_change` - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–¥–∏—Ç–µ–ª—è
- `send_message` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
- `join_ride` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ø–æ–µ–∑–¥–∫–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- `leave_ride` - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø–æ–µ–∑–¥–∫–∏

## –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `npm run db:seed` –≤ –±–∞–∑–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã:

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- **–ê–¥–º–∏–Ω**: —Ç–µ–ª. `+79991234567`, –ø–∞—Ä–æ–ª—å `123456`
- **–ö–ª–∏–µ–Ω—Ç**: —Ç–µ–ª. `+79991234568`, –ø–∞—Ä–æ–ª—å `123456`
- **–í–æ–¥–∏—Ç–µ–ª–∏**: —Ç–µ–ª. `+79991234569-571`, –ø–∞—Ä–æ–ª—å `123456`

### –¢–∏–ø—ã –ø–æ–µ–∑–¥–æ–∫:
- **–≠–∫–æ–Ω–æ–º**: –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 150‚ÇΩ + 25‚ÇΩ/–∫–º
- **–ö–æ–º—Ñ–æ—Ä—Ç**: –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 200‚ÇΩ + 35‚ÇΩ/–∫–º  
- **–ë–∏–∑–Ω–µ—Å**: –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 300‚ÇΩ + 50‚ÇΩ/–∫–º

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Rate limiting –¥–ª—è API endpoints
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- JWT —Ç–æ–∫–µ–Ω—ã —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —Å bcrypt
- CORS –∑–∞—â–∏—Ç–∞
- Helmet.js –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é Winston:
- `error.log` - —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
- `combined.log` - –≤—Å–µ –ª–æ–≥–∏
- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
2. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: `npm run build`
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: `npm start`
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ reverse proxy (nginx) –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ endpoint `/api/health`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ –≤ —Ñ–∞–π–ª–∞—Ö `error.log` –∏ `combined.log`
2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`
3. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. –ü–æ—Ä—Ç—ã –∏ firewall –Ω–∞—Å—Ç—Ä–æ–π–∫–∏